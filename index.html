<!DOCTYPE html>
<html>
<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
</head>
<body>


<script>
	function Q0001(exp) {
      var arr = exp.split("]TTT[");
      var x0 = arr[0].trim();
      var x1 = arr[1].trim();
      var x2 = arr[2].trim();
      var x3 = arr[3].trim();
      var x4 = arr[4].trim();
      var x5 = arr[5].trim();

      async function RunFirst() {
        let promise = new Promise((resolve, reject) => {
          setTimeout(function(){
            if (x0=='get') {
              var url = (x2=='NoLink') ? GetLink() : x2;
              Quang(resolve, url);
            } else {
              RunOther(resolve);
            }
          },5);
        });
        let result = await promise;
        if (result=="done!") { window[x3](x1); }
      }

      function Quang(resolve, url) {
        window.window[x1];
        $.getJSON(url, function (json) {
          window[x1] = json.records.map(doc => Object.values(doc));
          window[x1].map(function mapper(s) {
            if (Array.isArray(s)) {
              return s.map(mapper);
            } else {
              return s.toString().trim();
            }
          });
          resolve("done!");
        });
      }
      
      function RunOther(resolve) {
      	window.window['Toado'] = '';
		window[x4](x1,x3,x5);  
      }
      
      RunFirst();
    }
    
    function test(){
    	var exp = 'RunOther ]TTT[ Toado ]TTT[ NoLink ]TTT[ Func_Run01b ]TTT[ Func_Run01a ]TTT[ NoExp';
        Q0001(exp);
    }
   
    window.window['Func_Run01a'] = function Run01a(x1,x3,x5){
    	function handlePermission() {
          navigator.permissions.query({ name: 'geolocation' }).then((result) => {
            if (result.state === 'granted') {
              //alert(result.state);
              getVitri();
            } else if (result.state === 'prompt') {
              //alert(result.state);

            } else if (result.state === 'denied') {
              //alert(result.state);
            }
            result.addEventListener('change', () => {
              //alert(result.state);
              location.reload();
            });
          });
        }
        
        function getVitri(){
        	const Http = new XMLHttpRequest();
            function getLocation() {
            	var bdcApi = "https://api.bigdatacloud.net/data/reverse-geocode-client";
                  navigator.geolocation.getCurrentPosition(
            (position) => {
                          bdcApi = bdcApi + "?latitude=" + position.coords.latitude  + "&longitude=" + position.coords.longitude + "&localityLanguage=en";
                      getApi(bdcApi);

                      },
                      (err) => { getApi(bdcApi); },
                      {
                          enableHighAccuracy: true,
                          timeout: 5000,
                          maximumAge: 0
                      });
              }
              function getApi(bdcApi) {

				 Http.open("GET", bdcApi);
                  Http.send();
                  Http.onreadystatechange = function () {
                      if (this.readyState == 4 && this.status == 200) { 
                          window[x1] = this.responseText;
                          window[x3](x1);
                      } 

                  };
                 
              }

              getLocation();
              
        }
        
        handlePermission();         
    }

    window.window['Func_Run01b'] = function Run01b(x1){
    	if (window[x1] == '') {
        	alert('error');
        }else {
        	alert(window[x1]);
        }
    }
    
    test();
</script>

</body>
</html>

